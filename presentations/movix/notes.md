### Movix Billing Service

–Ø–Ω–¥–µ–∫—Å.–ü—Ä–∞–∫—Ç–∏–∫—É–º, 25 –ö–æ–≥–æ—Ä—Ç–∞, 7 –∫–æ–º–∞–Ω–¥–∞

<br>

##### –°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã

-   –°—Ç–∞–Ω–∏—Å–ª–∞–≤ –ë–æ–≥–∞—Ü–∫–∏–π, team lead, [github](https://github.com/sbkubric)
-   –í–∏–∫—Ç–æ—Ä –ì–æ—Å—Ç—è–π–∫–∏–Ω, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, [github](https://github.com/Viktor-Gostyaikin)
-   –°–µ—Ä–≥–µ–π –ö–æ–ª—Ç—É–Ω–æ–≤, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, [github](https://github.com/dogbusiness)

note: this is a not for a slide 1

h---

### –ö–∞–∫ –≤—Å—ë –Ω–∞—á–∏–Ω–∞–ª–æ—Å—å...

–ü–ª–∞–Ω –≤ –º–æ–µ–π –≥–æ–ª–æ–≤–µ:

![image](./content/start.png)

h---

### –•–æ—Ç–µ–ª–∫–∏ –±–∏–∑–Ω–µ—Å–∞

![buisiness-requirements](./content/business_requirements.png)

h---

### –ê —á—Ç–æ –¥–µ–ª–∞—Ç—å?

![–ú–µ–º —Å –¢—Ä–∞–≤–æ–ª—Ç–æ–π](https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fmedia1.tenor.com%2Fimages%2Fc224be2073156574d456f8f3b86d927a%2Ftenor.gif%3Fitemid%3D14193582&f=1&nofb=1&ipt=e41c4371396a0e6909169de7a0817247d87712a7f3a2d709c66f9bc1d9e3ec0c&ipo=images)

[comment]: <> (–°–ª–∞–π–¥ –¥–ª—è —Ñ—Ä–∞–∑—ã "–î–ª—è –Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏–º –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ)
h---

### C—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:

-   –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –≤ –∞–¥–º–∏–Ω–∫—É
-   –ü—Ä–æ–≤–æ–¥–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏
-   –î–µ–ª–∞—Ç—å —Ä–µ—Ñ–∞–Ω–¥—ã
-   –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂
-   –õ–µ–≥–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ –±–µ–∑ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

h---

### –ü–æ–¥–ø–∏—Å–∫–∞

–Ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –Ø —Ö–æ—á—É:

-   –Ø –∂–º—É "–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
-   –ü–æ–ø–∞–¥–∞—é –Ω–∞ —Ñ–æ—Ä–º—É —Å –≤—ã–±–æ—Ä–æ–º –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
-   –í–≤–æ–∂—É –ø–ª–∞—Ç–µ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
-   –ñ–º—É "–æ–ø–ª–∞—Ç–∏—Ç—å"
-   –í–∏–∂—É —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
-   –ò–¥—É —Å–º–æ—Ç—Ä–µ—Ç—å –∫–∏–Ω–æ üé•

h---

### –í–æ–∑–≤—Ä–∞—Ç

–Ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –Ø —Ö–æ—á—É:

-   –Ø –∂–º—É –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
-   –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é —Å–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ
-   –ü–æ–ª—É—á–∞—é –ø–∏—Å—å–º–æ –æ –≤–æ–∑–≤—Ä–∞—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤

h---

### –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–ª–∞—Ç–µ–∂–µ–π

–Ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –Ø —Ö–æ—á—É:

-   –í–∏–¥–µ—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
-   –í–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –ø–ª–∞—Ç–µ–∂–∞–º: –≤—Ä–µ–º—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Å—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏, —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–∞

h---

[comment]: <> (–°–µ—Ä–≤–∏—Å—ã)

### –û—Ç–ª–∏—á–Ω–æ, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –µ—Å—Ç—å. –ê –∫–∞–∫ –¥–µ–ª–∞—Ç—å –±—É–¥–µ–º?

![services](https://avatars.mds.yandex.net/i?id=71c84134dc73feeb9bb47bb24a798052a9361a07-10092505-images-thumbs&n=13)

h---

### –ß—Ç–æ –Ω–∞–º –≤–æ–æ–±—â–µ –Ω—É–∂–Ω–æ?

![entities](./content/entities.png)

h---

### –ö–∞–∂–µ—Ç—Å—è, –æ–¥–Ω–∏–º —Å–µ—Ä–≤–∏—Å–æ–º –¥–µ–ª–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—Å—è

![services](./content/services.svg)

h---

### –ü—Ä–∏–∫–∏–¥—ã–≤–∞–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–µ—Ä–≤–∏—Å–æ–≤

![general](./content/general.svg)

h---

### –ê —á—Ç–æ —Å —ç–∫–≤–∞–π—Ä–∏–Ω–≥–æ–º?

![cloudpayments](https://sovmart.ru/images/swjprojects/projects/2/ru-RU/cover.png)

h---

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∞–≤—Ç–æ–º–∞—Ç—ã

![automate](./content/automate.jpeg)

h---

### –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ transitions

<img src="./content/transitions.png" alt="drawing" width="50%" height="50%">

[pytransitions/transitions](https://github.com/pytransitions/transitions)

h---

### –ù–∞—á–Ω–µ–º —Å –¥–∞–Ω–Ω—ã—Ö

![data](https://avatars.mds.yandex.net/i?id=0ff0a7a78a4c6c7c209b89295a0ea563_l-4304125-images-thumbs&n=13)

h---

### –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö: –±–∏–ª–ª–∏–Ω–≥

![payments-schema](./content/payments_schema.drawio.svg)

note: –°–µ—Ä–µ–∂–∞:
–ü—Ä–∏–≤–µ—Ç. –ö–∞–∫ —É–∂–µ –±—ã–ª–æ —Å–∫–∞–∑–∞–Ω–æ, –º–µ–Ω—è –∑–æ–≤—É—Ç–°–µ—Ä–≥–µ–π –∏ —è –æ–¥–∏–Ω –∏–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.
–Ø —Ö–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ —Å—Ö–µ–º—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –±–∏–ª–ª–∏–Ω–≥–∞.

–ü–æ–∂–∞–ª—É–π, –≥–ª–∞–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ - Invoice. –í –Ω–µ–π —Ö—Ä–∞–Ω—è—Ç—Å—è –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ subscription-api.
–ó–¥–µ—Å—å –≤–æ–ø—Ä–æ—Å—ã –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ transaction_id - –ø–æ–ª–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –Ω–µ –∑–Ω–∞–µ–º –∫–∞–∫–æ–π —Ç–∏–ø —Ö—Ä–∞–Ω–∏—Ç —É —Å–µ–±—è –∏ –æ—Ç–¥–∞–µ—Ç –Ω–∞–º
—Ç–æ—Ç –∏–ª–∏ –∏–Ω–æ–π —ç–∫–≤–∞–π—Ä–∏–Ω–≥. –ú—ã —Ä–µ—à–∏–ª–∏ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≥–∏–±–∫–∏–º–∏ –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∞–π–¥–∏ –≤ —ç—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ.

–¢–∞–±–ª–∏—Ü–∞ —Ä–µ—Ñ–∞–Ω–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤.
–í–æ–∑–≤—Ä–∞—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –±–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞, –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –µ—Å—Ç—å FK –¥–ª—è invoice_id.
–¢–∞–∫ –∂–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è transaction_id (–≤–æ–∑–≤—Ä–∞—Ç —ç—Ç–æ –≤–µ–¥—å —Ç–æ–∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞)

–¢–∞–±–ª–∏—Ü–∞ acquiring_log –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö –≤ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–µ.
–¢–∞–º –º—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ª—é–±—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–∞–µ–º—ã–µ –æ—Ç —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞:
–Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ–¥ –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –Ω–∞–º –≤–µ—Ä–Ω—É–ª –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ.

h---

### –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö: –ø–æ–¥–ø–∏—Å–∫–∏

![sub-schema](./content/sub_schema.drawio.svg)

h---

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ?

<img src="./content/payments_1.png" alt="drawing" width="70%" height="70%"/>

h---

### –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã —Ö—É–∫–æ–≤ –ø–ª–∞—Ç–µ–∂–∞

  <div style="display: flex; flex-direction: row;">
    <img src="./content/payments_2.png" alt="drawing" width="50%" height="50%"/>
    <img src="./content/payments_3.png" alt="drawing" width="50%" height="50%"/>
  </div>
h---

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ

<img src="./content/refunds_v2.drawio.svg" alt="drawing" width="78%" height="75%"/>

note: –°–µ—Ä–µ–∂–∞:
–Ø —Ä–µ—à–∏–ª –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤–µ–±—Ö—É–∫ –æ—Ç —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ –∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –æ—Ç –Ω–∞—à–µ–≥–æ subscriptions-api –≤ –æ–¥–Ω—É —Å—Ö–µ–º—É.

–°–Ω–∞—á–∞–ª–∞ —É—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –≤ subscriptions-api, –∑–∞—Ç–µ–º –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É —ç–Ω–¥–ø–æ–∏–Ω—Ç—É –≤ –±–∏–ª–ª–∏–Ω–≥.
–ë–∏–ª–ª–∏–Ω–≥ –Ω–∞—Ö–æ–¥–∏—Ç –ø–ª–∞—Ç–µ–∂ –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç—è—Ç —Å–¥–µ–ª–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –∏ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É Refund. –ù–∞ —ç—Ç–æ–º –∂–µ —ç—Ç–∞–ø–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤–æ–∑–≤—Ä–∞—Ç –ø–æ —ç—Ç–æ–º—É –ø–ª–∞—Ç–µ–∂—É.
–ï—Å–ª–∏ –≤—Å–µ —Ö–æ—Ä–æ—à–æ, —Å–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ –≤ —Å—Ç–∞—Ç—É—Å–µ pending –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —ç–∫–≤–∞–π–µ—Ä—É.
–ï—Å–ª–∏ —ç–∫–≤–∞–π–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª —á–µ–º-—Ç–æ –∫—Ä–æ–º–µ 200, —Ñ–µ–π–ª–∏–º –ø–ª–∞—Ç–µ–∂ (–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Ñ–µ–π–ª–¥) –∏ –∑–∞–Ω–æ—Å–∏–º –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ acquiring_log.

h---

### –ü—Ä–æ—Ü–µ—Å—Å –±–∏–ª–ª–∏–Ω–≥–∞

```python3
class BillingProcessABC(asyncio.AsyncMachine, mixins.TableMixin, abc.ABC):
    def __init__(
        self, *args, aquiring_provider: protocols.AcquiringProviderProtocol, **kwargs
    ):
        self._transaction_id: str | None = None
        self._status: str | None = None
        self._session: asql.AsyncSession | None = None
        self._locked_entry: db.Invoice | db.Refund | None = None
        self._entry_id: uuid.UUID | None = None
        self._acquiring_provider: protocols.AcquiringProviderProtocol = (
            aquiring_provider
        )
        super().__init__(*args, **kwargs)

    async def _before_change(self, event: transitions.EventData):
        if not self.table is None or (
            self._entry_id is None and self._transaction_id is None
        ):
            return

        self._session = db_session.get()
        if self._entry_id:
            result = await self._session.execute(
                sql.Select(self.table)
                .where(self.table.id == self._entry_id)
                .with_for_update()  # TODO : explore timeout possibilites
            )
            self._locked_entry = typing.cast(
                db.Invoice | db.Refund | None, result.one_or_none()
            )
            return

        result = await self._session.execute(
            sql.Select(self.table)
            .where(
                sql.and_(
                    self.table.aquiring_provider == self._acquiring_provider.title,
                    self.table.transaction_id == self._transaction_id,
                )
            )
            .with_for_update()
        )
        self._locked_entry = result.one_or_none()  # type: ignore

    async def get_pid(self) -> uuid.UUID:
        if self._entry_id is None:
            raise exc.NotFoundError
        return self._entry_id

    async def _after_change(self, event: transitions.EventData):
        if (
            self._entry_id is None
            or self._session is None
            or self._locked_entry is None
        ):
            return
        await self._session.commit()
        self._session = None
        self._locked_entry = None

    async def _store(self, event: transitions.EventData):
        if self._entry_id is None or self._locked_entry is None:
            raise exc.LogicError
        self._locked_entry.process = pickle.dumps(self)
        statement = sql.update(self.table).where(self.table.id == self._entry_id)
        await self._session.execute(statement, (self._locked_entry,))  # type: ignore

    @abc.abstractmethod
    async def on_exception(self, event: transitions.EventData):
        ...
```

h---

### –ü—Ä–æ—Ü–µ—Å—Å –ø–ª–∞—Ç–µ–∂–∞

```python
class InvoiceProcessABC(BillingProcessABC, mixins.InvoiceTableMixin, abc.ABC):
    def __init__(self, *args, **kwargs):
        states = enums.InvoiceStates
        self._locked_entry: db.Invoice | None = None
        self.table = self.__class__.table
        super().__init__(
            self,
            *args,
            states=states,
            initial=enums.InvoiceStates.NONE,
            send_event=True,
            before_state_change=self._before_change,
            after_state_change=self._after_change,
            **kwargs,
        )
        self.add_transition('store', list(enums.InvoiceStates), '=', after=self._store)
        self.add_transition(
            'create',
            enums.InvoiceStates.NONE,
            enums.InvoiceStates.CREATED,
            before=self._before_create,
            after=self._after_create,
        )
        self.add_transition(
            'check',
            enums.InvoiceStates.CREATED,
            enums.InvoiceStates.PENDING,
            before=self._before_check,
            after=self._after_check,
            conditions=self._is_locked,
        )
        self.add_transition(
            'pay',
            enums.InvoiceStates.PENDING,
            enums.InvoiceStates.PAID,
            before=self._before_pay,
            after=self._after_pay,
            conditions=self._is_locked,
        )
        self.add_transition(
            'cancel',
            [enums.InvoiceStates.CREATED, enums.InvoiceStates.PAID],
            enums.InvoiceStates.CANCELED,
            before=self._before_cancel,
            after=self._after_cancel,
            conditions=self._is_locked,
        )
        self.add_transition(
            'fail',
            [enums.InvoiceStates.CREATED, enums.InvoiceStates.PAID],
            enums.InvoiceStates.FAILED,
            before=self._before_fail,
            after=self._after_fail,
            conditions=self._is_locked,
        )

    def _is_locked(self) -> bool:
        return bool(self._locked_entry)

```

h---

### –ü—Ä–æ—Ü–µ—Å—Å –≤–æ–∑–≤—Ä–∞—Ç–∞

```python
class RefundProcessABC(mixins.RefundTableMixin, BillingProcessABC, abc.ABC):
    table = db.Refund

    def __init__(self, *args, **kwargs):
        states = enums.RefundStates
        self._locked_entry: db.Refund | None = None
        super().__init__(
            self,
            *args,
            states=states,
            initial=enums.RefundStates.NONE,
            send_event=True,
            before_state_change=self._before_change,
            after_state_change=self._after_change,
            **kwargs,
        )
        self.add_transition('store', list(enums.InvoiceStates), '=', after=self._store)
        self.add_transition(
            'create',
            enums.RefundStates.NONE,
            enums.RefundStates.CREATED,
            before=self._before_create,
            after=self._after_create,
        )
        self.add_transition(
            'register',
            enums.RefundStates.CREATED,
            enums.RefundStates.PENDING,
            before=self._before_register,
            after=self._after_register,
            conditions=[self._is_locked],
        )
        self.add_transition(
            'refunded',
            enums.RefundStates.PENDING,
            enums.RefundStates.REFUNDED,
            prepare=self._lock,
            before=self._before_refund,
            after=self._after_refund,
            conditions=self._is_locked,
        )
        self.add_transition(
            'fail',
            [enums.RefundStates.CREATED, enums.RefundStates.PENDING],
            enums.RefundStates.FAILED,
            prepare=self._lock,
            before=self._before_fail,
            after=self._after_fail,
            conditions=self._is_locked,
        )

    async def _find_acquirer(self, event: transitions.EventData):
        ...

    def _is_locked(self, *args, **kwargs) -> bool:
        return bool(self._locked_entry)
```

h---

[comment]: <> (–î–µ–º–æ)

### –ê —Ç–µ–ø–µ—Ä—å —Å–º–æ—Ç—Ä–∏–º!

[comment]: <> (![](content/my_video.mov))

[–î–µ–º–∫–∞ –±–∏–ª–ª–∏–Ω–≥–∞](https://www.youtube.com/watch?v=dQw4w9WgXcQ&pp=ygUncmljayBhc3RsZXkgbmV2ZXIgZ29ubmEgZ2l2ZSB5b3UgdXAgb2xk)

h---

### –ß—Ç–æ –Ω–µ —É—Å–ø–µ–ª–∏?

-   —Å–µ—Ä–≤–∏—Å –ø–æ–¥–ø–∏—Å–æ–∫ (–≥–æ—Ç–æ–≤ —Ç–æ–ª—å–∫–æ barebone –∏ –ø–∞—Ä–∞ —ç–Ω–¥–ø–æ–π–Ω—Ç–æ–≤)

h---

### –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å?

-   —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
-   Event-driven –æ–±—â–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

h---

### –í–æ–ø—Ä–æ—Å—ã?
